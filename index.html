<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>IMF ê²½ì œ í†µê³„ ëŒ€ì‹œë³´ë“œ</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
            padding: 30px;
        }

        h1 {
            text-align: center;
            color: #333;
            margin-bottom: 10px;
            font-size: 2.5em;
        }

        .subtitle {
            text-align: center;
            color: #666;
            margin-bottom: 30px;
            font-size: 1.1em;
        }

        .controls {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            margin-bottom: 30px;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 10px;
        }

        .control-group {
            flex: 1;
            min-width: 200px;
        }

        label {
            display: block;
            margin-bottom: 5px;
            color: #555;
            font-weight: 600;
        }

        select, input {
            width: 100%;
            padding: 10px;
            border: 2px solid #ddd;
            border-radius: 5px;
            font-size: 14px;
            transition: border-color 0.3s;
        }

        select:focus, input:focus {
            outline: none;
            border-color: #667eea;
        }

        button {
            padding: 12px 30px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 5px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
            align-self: flex-end;
        }

        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        button:active {
            transform: translateY(0);
        }

        button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .charts-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(500px, 1fr));
            gap: 30px;
            margin-top: 30px;
        }

        .chart-wrapper {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .chart-title {
            font-size: 1.3em;
            color: #333;
            margin-bottom: 15px;
            text-align: center;
            font-weight: 600;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #666;
            font-size: 1.2em;
        }

        .error {
            background: #fee;
            color: #c33;
            padding: 15px;
            border-radius: 5px;
            margin: 20px 0;
            border-left: 4px solid #c33;
        }

        .info-box {
            background: #e7f3ff;
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 20px;
            border-left: 4px solid #2196F3;
        }

        @media (max-width: 768px) {
            .charts-container {
                grid-template-columns: 1fr;
            }
            
            h1 {
                font-size: 1.8em;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸŒ IMF ê²½ì œ í†µê³„ ëŒ€ì‹œë³´ë“œ</h1>
        <p class="subtitle">ê°êµ­ì˜ ì£¼ìš” ê²½ì œ ì§€í‘œë¥¼ ë¹„êµí•˜ê³  ì‹œê°í™”í•©ë‹ˆë‹¤</p>

        <div class="info-box">
            <strong>ì‚¬ìš© ë°©ë²•:</strong> êµ­ê°€ì™€ ì§€í‘œë¥¼ ì„ íƒí•œ í›„ "ë°ì´í„° ë¶ˆëŸ¬ì˜¤ê¸°" ë²„íŠ¼ì„ í´ë¦­í•˜ì„¸ìš”. 
            Netlify Functionsë¥¼ í†µí•´ IMF Data Portal APIì—ì„œ ìµœì‹  ê²½ì œ í†µê³„ ë°ì´í„°ë¥¼ ê°€ì ¸ì˜µë‹ˆë‹¤.
        </div>

        <div class="controls">
            <div class="control-group">
                <label for="country">êµ­ê°€ ì„ íƒ:</label>
                <select id="country">
                    <option value="US">ë¯¸êµ­ (United States)</option>
                    <option value="CN">ì¤‘êµ­ (China)</option>
                    <option value="JP">ì¼ë³¸ (Japan)</option>
                    <option value="DE">ë…ì¼ (Germany)</option>
                    <option value="GB">ì˜êµ­ (United Kingdom)</option>
                    <option value="FR">í”„ë‘ìŠ¤ (France)</option>
                    <option value="KR">í•œêµ­ (Korea)</option>
                    <option value="IN">ì¸ë„ (India)</option>
                    <option value="BR">ë¸Œë¼ì§ˆ (Brazil)</option>
                    <option value="RU">ëŸ¬ì‹œì•„ (Russia)</option>
                </select>
            </div>
            <div class="control-group">
                <label for="indicator">ê²½ì œ ì§€í‘œ ì„ íƒ:</label>
                <select id="indicator">
                    <option value="NGDP_RPCH">GDP ì„±ì¥ë¥  (ì—°ê°„ %)</option>
                    <option value="PCPIPCH">ì¸í”Œë ˆì´ì…˜ìœ¨ (ì—°ê°„ %)</option>
                    <option value="LUR">ì‹¤ì—…ë¥  (%)</option>
                    <option value="NGDPD">GDP (í˜„ì¬ ê°€ê²©, USD)</option>
                    <option value="BCA">ê²½ìƒìˆ˜ì§€ (GDP ëŒ€ë¹„ %)</option>
                </select>
            </div>
            <div class="control-group">
                <label for="startYear">ì‹œì‘ ì—°ë„:</label>
                <input type="number" id="startYear" value="2015" min="1980" max="2024">
            </div>
            <div class="control-group">
                <label for="endYear">ì¢…ë£Œ ì—°ë„:</label>
                <input type="number" id="endYear" value="2024" min="1980" max="2024">
            </div>
            <div class="control-group">
                <button id="loadData" onclick="loadIMFData()">ë°ì´í„° ë¶ˆëŸ¬ì˜¤ê¸°</button>
            </div>
        </div>

        <div id="errorMessage"></div>
        <div id="loadingMessage" class="loading" style="display: none;">ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>
        
        <div class="charts-container" id="chartsContainer">
            <div class="chart-wrapper">
                <div class="chart-title">ì„  ê·¸ë˜í”„</div>
                <canvas id="lineChart"></canvas>
            </div>
            <div class="chart-wrapper">
                <div class="chart-title">ë§‰ëŒ€ ê·¸ë˜í”„</div>
                <canvas id="barChart"></canvas>
            </div>
        </div>
    </div>

    <script>
        let lineChartInstance = null;
        let barChartInstance = null;

        // IMF Data Portal APIë¥¼ ì‚¬ìš©í•˜ì—¬ ë°ì´í„° ê°€ì ¸ì˜¤ê¸°
        async function loadIMFData() {
            const country = document.getElementById('country').value;
            const indicator = document.getElementById('indicator').value;
            const startYear = document.getElementById('startYear').value;
            const endYear = document.getElementById('endYear').value;

            // ì…ë ¥ ê²€ì¦
            if (parseInt(startYear) > parseInt(endYear)) {
                showError('ì‹œì‘ ì—°ë„ëŠ” ì¢…ë£Œ ì—°ë„ë³´ë‹¤ ì‘ì•„ì•¼ í•©ë‹ˆë‹¤.');
                return;
            }

            document.getElementById('loadingMessage').style.display = 'block';
            document.getElementById('errorMessage').innerHTML = '';
            document.getElementById('loadData').disabled = true;

            try {
                // Netlify Functionì„ í†µí•´ IMF API í˜¸ì¶œ (CORS ë¬¸ì œ í•´ê²°)
                // Netlify FunctionsëŠ” /.netlify/functions/ ê²½ë¡œë¡œ ì ‘ê·¼í•©ë‹ˆë‹¤
                const functionUrl = `/.netlify/functions/imf-api?indicator=${encodeURIComponent(indicator)}&country=${encodeURIComponent(country)}&startYear=${encodeURIComponent(startYear)}&endYear=${encodeURIComponent(endYear)}`;
                
                console.log('Function URL:', functionUrl);
                
                const response = await fetch(functionUrl);
                
                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({}));
                    const errorMessage = errorData.error || errorData.message || `HTTP error! status: ${response.status}`;
                    console.error('API ì˜¤ë¥˜:', errorMessage, errorData);
                    throw new Error(errorMessage);
                }
                
                const imfData = await response.json();
                console.log('ë°›ì€ ë°ì´í„°:', imfData);

                // ë°ì´í„° ì²˜ë¦¬
                processData(imfData, country, indicator);
                
            } catch (error) {
                console.error('ë°ì´í„° ë¡œë”© ì˜¤ë¥˜:', error);
                const errorMsg = `ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ${error.message}`;
                showError(errorMsg + '<br><small>ë¸Œë¼ìš°ì € ì½˜ì†”(F12)ì—ì„œ ìì„¸í•œ ì˜¤ë¥˜ë¥¼ í™•ì¸í•˜ì„¸ìš”.</small>');
                
                // ìƒ˜í”Œ ë°ì´í„°ë¡œ ë°ëª¨ í‘œì‹œ
                showSampleData(country, indicator, startYear, endYear);
            } finally {
                document.getElementById('loadingMessage').style.display = 'none';
                document.getElementById('loadData').disabled = false;
            }
        }

        function processData(data, country, indicator) {
            try {
                console.log('ë°ì´í„° íŒŒì‹± ì‹œì‘:', data);
                
                // IMF API ì‘ë‹µ êµ¬ì¡° íŒŒì‹±
                // IMF APIëŠ” ë³´í†µ {values: {indicator: {country: {year: value}}}} í˜•íƒœë¡œ ë°˜í™˜
                let values = {};
                
                // IMF APIì˜ ì‹¤ì œ ì‘ë‹µ êµ¬ì¡°ì— ë§ì¶° íŒŒì‹±
                if (data.values) {
                    // {values: {NGDP_RPCH: {US: {2020: 2.3, 2021: 5.7}}}}
                    if (data.values[indicator]) {
                        if (data.values[indicator][country]) {
                            values = data.values[indicator][country];
                        } else {
                            // êµ­ê°€ ì½”ë“œê°€ ë‹¤ë¥¸ ê²½ìš° ì‹œë„
                            const countryUpper = country.toUpperCase();
                            if (data.values[indicator][countryUpper]) {
                                values = data.values[indicator][countryUpper];
                            }
                        }
                    }
                } else if (data[country]) {
                    // ì§ì ‘ êµ­ê°€ ì½”ë“œë¡œ ì ‘ê·¼
                    values = data[country];
                } else if (data[indicator] && data[indicator][country]) {
                    // {indicator: {country: {year: value}}}
                    values = data[indicator][country];
                } else if (Array.isArray(data)) {
                    // ë°°ì—´ í˜•íƒœì¸ ê²½ìš°
                    const dataObj = {};
                    data.forEach(item => {
                        if (item.period && item.value !== undefined) {
                            const year = parseInt(item.period.split('-')[0]);
                            if (year) dataObj[year] = item.value;
                        }
                    });
                    values = dataObj;
                } else {
                    // ì „ì²´ ë°ì´í„° êµ¬ì¡° ì¶œë ¥í•˜ì—¬ ë””ë²„ê¹…
                    console.warn('ì•Œ ìˆ˜ ì—†ëŠ” ë°ì´í„° êµ¬ì¡°:', data);
                    // ë§ˆì§€ë§‰ ì‹œë„: ì „ì²´ ê°ì²´ì—ì„œ ì—°ë„ í‚¤ ì°¾ê¸°
                    for (const key in data) {
                        if (!isNaN(key) && key.length === 4) {
                            values[key] = data[key];
                        }
                    }
                }
                
                console.log('ì¶”ì¶œëœ ê°’ë“¤:', values);
                
                const labels = [];
                const chartData = [];
                const startYear = parseInt(document.getElementById('startYear').value);
                const endYear = parseInt(document.getElementById('endYear').value);

                // ì—°ë„ë³„ ë°ì´í„° ì¶”ì¶œ
                for (let year = startYear; year <= endYear; year++) {
                    labels.push(year.toString());
                    
                    // ë‹¤ì–‘í•œ í˜•ì‹ì˜ í‚¤ ì‹œë„
                    let value = null;
                    if (values[year] !== undefined && values[year] !== null) {
                        value = values[year];
                    } else if (values[year.toString()] !== undefined && values[year.toString()] !== null) {
                        value = values[year.toString()];
                    } else if (values[`${year}-01-01`] !== undefined) {
                        value = values[`${year}-01-01`];
                    }
                    
                    // ìˆ«ìë¡œ ë³€í™˜ (ë¬¸ìì—´ì¸ ê²½ìš°)
                    if (value !== null && value !== undefined) {
                        const numValue = parseFloat(value);
                        chartData.push(isNaN(numValue) ? null : numValue);
                    } else {
                        chartData.push(null);
                    }
                }

                // ë°ì´í„°ê°€ ëª¨ë‘ nullì¸ì§€ í™•ì¸
                const hasData = chartData.some(v => v !== null);
                if (!hasData) {
                    throw new Error('í•´ë‹¹ ê¸°ê°„ì— ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤. ë‹¤ë¥¸ ì—°ë„ ë²”ìœ„ë¥¼ ì„ íƒí•´ë³´ì„¸ìš”.');
                }

                // ì°¨íŠ¸ ì—…ë°ì´íŠ¸
                updateCharts(labels, chartData, getIndicatorName(indicator), country);
                
            } catch (error) {
                console.error('ë°ì´í„° ì²˜ë¦¬ ì˜¤ë¥˜:', error);
                console.error('ë°›ì€ ë°ì´í„°:', JSON.stringify(data, null, 2));
                showError(`ë°ì´í„°ë¥¼ ì²˜ë¦¬í•˜ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ${error.message}<br><small>ë¸Œë¼ìš°ì € ì½˜ì†”(F12)ì—ì„œ ìì„¸í•œ ì •ë³´ë¥¼ í™•ì¸í•˜ì„¸ìš”.</small>`);
                showSampleData(country, indicator, 
                    document.getElementById('startYear').value, 
                    document.getElementById('endYear').value);
            }
        }

        function showSampleData(country, indicator, startYear, endYear) {
            // ìƒ˜í”Œ ë°ì´í„° ìƒì„± (API ì ‘ê·¼ ì‹¤íŒ¨ ì‹œ ë°ëª¨ìš©)
            const labels = [];
            const chartData = [];
            
            for (let year = parseInt(startYear); year <= parseInt(endYear); year++) {
                labels.push(year.toString());
                // ëœë¤ ìƒ˜í”Œ ë°ì´í„° ìƒì„±
                chartData.push((Math.random() * 10 - 2).toFixed(2));
            }

            updateCharts(labels, chartData, getIndicatorName(indicator), country);
            
            showError('âš ï¸ IMF APIì—ì„œ ë°ì´í„°ë¥¼ ê°€ì ¸ì˜¬ ìˆ˜ ì—†ì–´ ìƒ˜í”Œ ë°ì´í„°ë¥¼ í‘œì‹œí•©ë‹ˆë‹¤. Netlify Functionì´ ì œëŒ€ë¡œ ë°°í¬ë˜ì—ˆëŠ”ì§€ í™•ì¸í•˜ì„¸ìš”.');
        }

        function updateCharts(labels, data, indicatorName, country) {
            const countryName = document.getElementById('country').selectedOptions[0].text;
            
            // ì„  ê·¸ë˜í”„
            const lineCtx = document.getElementById('lineChart').getContext('2d');
            if (lineChartInstance) {
                lineChartInstance.destroy();
            }
            lineChartInstance = new Chart(lineCtx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: `${countryName} - ${indicatorName}`,
                        data: data,
                        borderColor: 'rgb(102, 126, 234)',
                        backgroundColor: 'rgba(102, 126, 234, 0.1)',
                        borderWidth: 3,
                        fill: true,
                        tension: 0.4,
                        pointRadius: 5,
                        pointHoverRadius: 7
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    plugins: {
                        legend: {
                            display: true,
                            position: 'top'
                        },
                        tooltip: {
                            mode: 'index',
                            intersect: false
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: false,
                            title: {
                                display: true,
                                text: indicatorName
                            }
                        },
                        x: {
                            title: {
                                display: true,
                                text: 'ì—°ë„'
                            }
                        }
                    }
                }
            });

            // ë§‰ëŒ€ ê·¸ë˜í”„
            const barCtx = document.getElementById('barChart').getContext('2d');
            if (barChartInstance) {
                barChartInstance.destroy();
            }
            barChartInstance = new Chart(barCtx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: `${countryName} - ${indicatorName}`,
                        data: data,
                        backgroundColor: 'rgba(118, 75, 162, 0.7)',
                        borderColor: 'rgba(118, 75, 162, 1)',
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    plugins: {
                        legend: {
                            display: true,
                            position: 'top'
                        },
                        tooltip: {
                            mode: 'index',
                            intersect: false
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: false,
                            title: {
                                display: true,
                                text: indicatorName
                            }
                        },
                        x: {
                            title: {
                                display: true,
                                text: 'ì—°ë„'
                            }
                        }
                    }
                }
            });
        }

        function getIndicatorName(code) {
            const names = {
                'NGDP_RPCH': 'GDP ì„±ì¥ë¥  (%)',
                'PCPIPCH': 'ì¸í”Œë ˆì´ì…˜ìœ¨ (%)',
                'LUR': 'ì‹¤ì—…ë¥  (%)',
                'NGDPD': 'GDP (USD)',
                'BCA': 'ê²½ìƒìˆ˜ì§€ (GDP ëŒ€ë¹„ %)'
            };
            return names[code] || code;
        }

        function showError(message) {
            document.getElementById('errorMessage').innerHTML = `<div class="error">${message}</div>`;
        }

        // í˜ì´ì§€ ë¡œë“œ ì‹œ ì´ˆê¸° ë°ì´í„° ë¡œë“œ
        window.addEventListener('load', () => {
            // ì´ˆê¸° ë¡œë“œëŠ” í•˜ì§€ ì•Šê³  ì‚¬ìš©ìê°€ ë²„íŠ¼ì„ í´ë¦­í•˜ë„ë¡ í•¨
        });
    </script>
</body>
</html>

